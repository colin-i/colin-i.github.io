
<a href="#" onclick="history.back()">Click here to go back</a>

<script type="module">
import { Octokit } from "https://cdn.skypack.dev/@octokit/core";

const octokit = new Octokit({
  auth: 'github_pat_'+'11ACTLOTY0WKpwsmTKIAl8_WC88XGSlRbWIHztTWt3c0zourkSlVkT3dETNxlkQQidRBUGFNQVGqKrzSYg'
			//it expires if pushed without +
});

function btol(obj){
	const timeleft = obj.charCodeAt(0) | (obj.charCodeAt(1) << 8) | (obj.charCodeAt(2) << 16) | (obj.charCodeAt(3) << 24);
	obj=obj.slice(4);
	const timeright = obj.charCodeAt(0) | (obj.charCodeAt(1) << 8) | (obj.charCodeAt(2) << 16) | (obj.charCodeAt(3) << 24);
	return 2**32*timeright + timeleft;
}
function atod(a){
	let out=[];
	let obj=atob(a);
	while(obj.length!=0){
		const score = obj.charCodeAt(0) | (obj.charCodeAt(1) << 8) | (obj.charCodeAt(2) << 16) | (obj.charCodeAt(3) << 24);
		obj=obj.slice(4);
		let i;
		for(i=0;i<obj.length;i++)if(obj.charCodeAt(i)==0)break;
		const name=obj.substr(0,i);
		obj=obj.slice(i+1);
		for(i=0;i<obj.length;i++)if(obj.charCodeAt(i)==0)break;
		const comment=obj.substr(0,i);
		obj=obj.slice(i+1);
		const time=new Date(btol(obj)*1000);
		obj=obj.slice(8);
		const item={
			score: score,
			name: name,
			comment: comment,
			time: time
		}
		out.push(item);
	}
	return out;
}
function atol(a){
	return btol(atob(a));
}
function dgoh(d,main,sum){
	document.body.innerHTML+="<br><h3>"+main+" Top</h3>";
	let table="<table style='border:1px solid'><tr><th></th><th>Name</th><th>Score</th><th>Date</th><th>Comment</th></tr>";
	for(let i=0;i<d.length;i++){
		const x=d[i];
		table+="<tr><td>"+(i+1)+"</td><td>"+x.name+"</td><td>"+x.score.toString()+"</td><td>"+x.time.toString()+"</td><td>"+x.comment+"</td></tr>";
	}
	document.body.innerHTML+=table+"</table>";
	document.body.innerHTML+="<p>Total entries: "+sum.toString()+"</p>";
}

let game;
async function get_content(clas,ext=""){
	const obj=await octokit.request("GET /repos/colin-i/experimental/contents/"+clas+"/"+game+ext, {ref: 'main'});
	return obj.data.content;
}

const queryString = self.location.search;
const urlParams = new URLSearchParams(queryString);

if(urlParams.has('game_name')){
	const gn='game_name';
	game = urlParams.get(gn)
	const recent=atod(await get_content("recent"));
	const recentsum=atol(await get_content("recent",".tot"));
	const last=atod(await get_content("last"));
	const lastsum=atol(await get_content("last",".tot"));
	const alltime=atod(await get_content("data"));
	const alltimesum=atol(await get_content("data",".tot"));
	if(urlParams.has('score_text')){
		const name = urlParams.get('name_text')
		const score = urlParams.get('score_text')
		const comment = urlParams.get('comment_text')
		await octokit.request('POST /repos/colin-i/experimental/actions/workflows/39687662/dispatches', {
			ref: 'main',
			inputs: {
				game: game,
				name: name,
				score: score,
				comment: comment
			}
		})
		const item={
			score: score,
			name: name,
			comment: comment,
			time: time
		}
		document.body.innerHTML+="<p>Score sent: "+score+"</p>";
	}
	document.body.innerHTML+="<p><a href='"+self.location.href.split('?')[0]+"?"+gn+"="+game_name+"'>Click here to refresh</a></p>";
	dgoh(recent,"This Month",recentsum);
	dgoh(last,"Last Month",lastsum);
	dgoh(alltime,"All Time",alltimesum);
}
</script>
